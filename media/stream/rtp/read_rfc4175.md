# RFC4175解析

## 概要

该文档根据[RFC4175](./resource/rfc4175.pdf)中的内容进行分析编写，主要介绍未压缩视频数据的RTP打包方式。

## 报文头

标准RTP报头之后是2字节扩展RTP序列号字段，以及包括的视频的每一行（或部分行）的6字节有效负载报头。随后是视频数据的一行或多行或部分行。这种格式使有效负载报头在常见情况下32位对齐，其中每个RTP数据包中包括一条视频扫描线（或片段）。

报文示例：

```txt
 |       0       |       1       |       2       |       3       |
  0 1 2 3 4 5 6 7 0 1 2 3 4 5 6 7 0 1 2 3 4 5 6 7 0 1 2 3 4 5 6 7
 +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
 | V |P|X|   CC  |M|    PT       |       Sequence Number         |
 +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
 |                           Time Stamp                          |
 +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
 |                             SSRC                              |
 +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
 |   Extended Sequence Number    |            Length             |
 +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
 |F|          Line No            |C|           Offset            |
 +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
 |            Length             |F|          Line No            |
 +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
 |C|           Offset            |                               .
 +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+                               .
 .                                                               .
 .                 Two (partial) lines of video data             .
 .                                                               .
 +---------------------------------------------------------------+
 ```

### Payload Header

>Payload Header中的字段值都按网络字节序存放。

- Extended Sequence Number: 16 bits
  扩展32位序列号的高位。当RTP Sequence Number字段溢出时该字段+1。

- Line Header: 48bits
  一个RTP包中可能有多行数据，相应的会有多个Line Header。

  - Length: 16 bits
    当前数据报文中包含的一行数据的长度，单位字节。必须是pgroup值的整数倍。

  - Field Identification (F): 1 bit
    标识隔行扫描数据，F=0表示顶场扫描线，F=1表示底场扫描线。对于逐行扫描数据这个字段始终为0。
  
  - Line No.: 15 bits
    表示幅面数据中的行号。如果对一行数据进行分段传输（多个rtp包传输同一行的不同部分），该字段的值必须相同。

  - Continuation (C): 1 bit
    用于确定RTP数据包中的当前LineHeader标头之后是否有其他的Line Header。C=1表示随后还有报头，这意味着RTP数据包正在承载多条扫描线的数据。C=0表示后续数据是幅面的行内数据。确定每个数据包包含的扫描行数的唯一方法是解析Payload Header。

  - Offset: 15 bits
    行内有效负载数据的第一个像素的偏移量（注意不是字节偏移）。第一个像素Offset=0，这个值总是等于pgroup中像素个数的整数倍。

## 负载数据打包方式

无论视频数据是YCbCr还是RGB格式，打包到RTP报文中都使用采样分量交错打包方式。对于不同的采样深度会导致打包后的bit位冗余，

具体的分量排列顺序和像素打包分组方式如下文。

### RGB格式

RGB视频采样数据排列：

```txt

line 0: (R00 G00 B00) (R01 G01 B01) (R02 G02 B02) (R03 G03 B03) (R04 G04 B04)
line 1: (R10 G10 B10) (R11 G11 B11) (R12 G12 B12) (R13 G13 B13) (R14 G14 B14)
line 2: (R10 G20 B20) (R21 G21 B21) (R22 G22 B22) (R23 G23 B23) (R24 G24 B24)

```

8bit采样以1个像素为一组打包，一组3字节，打包顺序R-G-B，例如：R00 G00 B00。
10bit采样数据以4个像素为一组打包，一组15字节，打包顺序R-G-B-R-G-B-R-G-B-R-G-B，例如：R00 G00 B00 R01 G01 B01 R02 G02 B02 R023G03 B03。
12bit采样数据以2个像素为一组打包，一组9字节，打包顺序R-G-B-R-G-B。
16bit采样数据以1个像素为一组打包，一组6字节，打包顺序R-G-B。

对于BGR格式数据，和RGB不同的只是采样数据打包顺序改为B-G-R，对于不同的采样位数的像素打包分组方式还是和RGB相同的。

对于RGBA格式数据打包顺序是R-G-B-A。对于BGRA数据打包顺序是B-G-R-A。8bit、10bit、12bit和16bit都以1个像素为一组打包，每组分别对应4Bytes、5Bytes、6Bytes和8Bytes。

### YCbCr格式

如果视频数据为YCbCr格式，则打包方式取决于所使用的颜色采样模式。

#### YCbCr4:4:4

444采样矩阵：

```txt

line 0: (Y00 Cb00 Cr00) (Y01 Cb01 Cr01) (Y02 Cb02 Cr02) (Y03 Cb03 Cr03)
line 1: (Y10 Cb10 Cr10) (Y11 Cb11 Cr11) (Y12 Cb12 Cr12) (Y13 Cb13 Cr13)
line 2: (Y20 Cb20 Cr20) (Y21 Cb21 Cr21) (Y22 Cb22 Cr22) (Y23 Cb23 Cr23)

```

444格式的逐行扫描和隔行扫描数据采样打包顺序都是Cb-Y-Cr。

8bit采样以1个像素为一组打包，一组3字节，例如：Cb00 Y00 Cr00。
10bit采样数据以4个像素为一组打包，一组15字节。
12bit采样数据以2个像素为一组打包，一组9字节。
16bit采样数据以1个像素为一组打包，一组6字节。

#### YCbCr4:2:2

422采样矩阵：

```txt

line 0: (Y00 Cb00 Cr00 Y01) (Y02 Cb01 Cr01 Y03) (Y04 Cb02 Cr02 Y05) (Y06 Cb03 Cr03 Y07)
line 1: (Y10 Cb10 Cr10 Y11) (Y12 Cb11 Cr11 Y13) (Y14 Cb12 Cr12 Y15) (Y16 Cb13 Cr13 Y17)
line 2: (Y20 Cb20 Cr20 Y21) (Y22 Cb21 Cr21 Y23) (Y24 Cb22 Cr22 Y25) (Y26 Cb23 Cr23 Y27)

```

422格式的逐行扫描和隔行扫描数据采样打包顺序都是Cb-Y-Cr-Y。

8bit采样以2个像素为一组打包，一组4字节，例如：Cb00 Y00 Cr00 Y01 Cb01 Y02 Cr01 Y03。
10bit采样数据以2个像素为一组打包，一组5字节。
12bit采样数据以2个像素为一组打包，一组6字节。
16bit采样数据以2个像素为一组打包，一组8字节。

#### YCbCR4:1:1

411采样矩阵：

```txt

line 0: (Y00 Cb00 Cr00 Y01 Y02 Y03) (Y04 Cb01 Cr01 Y05 Y06 Y07)
line 1: (Y10 Cb10 Cr10 Y11 Y12 Y13) (Y14 Cb11 Cr11 Y15 Y16 Y17)
line 2: (Y20 Cb20 Cr20 Y21 Y22 Y23) (Y24 Cb21 Cr21 Y25 Y26 Y27)

```

411格式的逐行扫描和隔行扫描数据采样打包顺序都是Cb-Y-Y-Cr-Y-Y。

8bit采样以4个像素为一组打包，一组6字节，例如：Cb00 Y00 Y01 Cr00 Y02 Y03。
10bit采样数据以4个像素为一组打包，一组15字节。
12bit采样数据以4个像素为一组打包，一组9字节。
16bit采样数据以4个像素为一组打包，一组12字节。

#### YCbCr4:2:0

420采样矩阵：

```txt

 line 0: Y00 Y01 Y02 Y03 Y04 Y05
          Cb00    Cb01    Cb02
          Cr00    Cr01    Cr02
 line 1: Y10 Y11 Y12 Y13 Y14 Y15

 line 2: Y20 Y21 Y22 Y23 Y24 Y25
          Cb10    Cb11    Cb12
          Cr10    Cr11    Cr12
 line 3: Y30 Y31 Y32 Y33 Y34 Y35

```

420颜色分量在两行像素间共享，逐行扫描中采样打包顺序为Y-Y-Y-Y-Cb-Cr。

8bit采样以4个像素为一组打包，一组6字节，例如：Y00-Y01-Y10-Y11-Cb00-Cr00 Y02-Y03-Y12-Y13-Cb01-Cr01。
10bit采样数据以8个像素为一组打包，一组15字节。
12bit采样数据以4个像素为一组打包，一组9字节。
16bit采样数据以4个像素为一组打包，一组12字节。

这时Line Header中的`Line No.`字段取两行中的第一行编号。例如打包line 0/1:Y00-Y01-Y10-Y11-Cb00-Cr00 Y02-Y03-Y12-Y13-Cb01-Cr01 时`Line No.`=0。

隔行扫描中颜色分量采样每隔一行传输一次，第一组颜色分量数据可以在顶场的第一行数据传输也可以在底场的第一行数据传输，如果在顶场数据传输的第一行携带了颜色分量，那么必须在底场数据传输中第二行携带颜色分量。例如：

```txt
field 0:
 line 0: Y00-Y01-Cb00-Cr00 Y02-Y03-Cb01-Cr01 Y04-Y05-Cb02-Cr02
 line 2: Y20-Y21 Y22-Y23 Y24-Y25
 line 4: Y40-Y41-Cb20-Cr20 Y42-Y43-Cb21-Cr21 Y44-Y45-Cb22-Cr22
field 1:
 line 1: Y10-Y11 Y12-Y13 Y14-Y15
 line 3: Y30-Y31-Cb10-Cr10 Y32-Y33-Cb11-Cr11 Y34-Y35-Cb12-Cr12
 line 5: Y50-Y51 Y52-Y53 Y54-Y55
```

## RTP传输打包

通过上面的数据包头和Payload打包方式可以推导出一帧未压缩视频数据的RTP打包传输方式，首先对一场画面划分行（行可能是单行数据也可能是两行数据，例如420采样），再将行划分成若干个最小像素组，以像素组为单位组织RTP包。

除了444-8bit和444-16bit按照单个像素分组外一般都是以多个像素为一组，按照RFC4175的规定每个像素组字节大小必须相同，这样就会遇到像素组数据对齐问题（比如width=1081的422数据），这时最后一个像素组需要通过填0将无效数据填充对齐。

组织RTP包时需要考虑网络MTU限制划分每个RTP的负载大小，保证不超过MTU限制的情况下将每个RTP包的负载大小设置为相同值。

下面以一帧8K(7680x4320) 422 10bit视频数据来分析码流的打包过程：

每一行视频数据大小为7680/2*5=19200Bytes(pixels=2 group=5Bytes)。受以太网MTU限制每个RTP包发送1280Byts视频数据，相当于每512个像素一个Packets进行打包。

### 示例

8K(7680x4320) 422 10bit数据按照逐行扫描方式打包：

```plaintxt

+=============[ Packet #1 ]=============+
|                  ...                  |  Seq counter=0 Extened Seq counter=0
|                  ...                  |  Length=1280
|             line header               |  F=0 Line=0 C=0 Offset=0
|>>...data(line=1/4320)            ...<<|  
+---------------------------------------+
|                  ...                  |  Seq counter=1 Extened Seq counter=0
|                  ...                  |  Length=1280
|             line header               |  F=0 Line=0 C=0 Offset=512
|>>...data(line=1/4320)            ...<<|  
+---------------------------------------+
:                                       :
+---------------------------------------+
|                  ...                  |  Seq counter=15 Extened Seq counter=0
|                  ...                  |  Length=1280
|             line header               |  F=0 Line=1 C=0 Offset=0
|>>...  data(line=2/4320)          ...<<|  
+---------------------------------------+
:                                       :
+---------------------------------------+
|                  ...                  |  Seq counter=64799 Extened Seq counter=0
|                  ...                  |  Length=1280
|             line header               |  F=0 Line=4319 C=0 Offset=7168
|>>...data(line=4320/4320)         ...<<|
+=======================================+

```

8K(7680x4320) 422 10bit数据按照隔行扫描方式打包：

```plaintxt
顶场：
+=============[ Packet #1 ]=============+
|                  ...                  |  Seq counter=0 Extened Seq counter=0
|                  ...                  |  Length=1280
|             line header               |  F=0 Line=0 C=0 Offset=0
|>>...data(line=1/2160)            ...<<|  
+---------------------------------------+
|                  ...                  |  Seq counter=1 Extened Seq counter=0
|                  ...                  |  Length=1280
|             line header               |  F=0 Line=0 C=0 Offset=512
|>>...data(line=1/2160)            ...<<|  
+---------------------------------------+
:                                       :
+---------------------------------------+
|                  ...                  |  Seq counter=15 Extened Seq counter=0
|                  ...                  |  Length=1280
|             line header               |  F=0 Line=2 C=0 Offset=0
|>>...  data(line=2/2160)          ...<<|  
+---------------------------------------+
:                                       :
+---------------------------------------+
|                  ...                  |  Seq counter=32399 Extened Seq counter=0
|                  ...                  |  Length=1280
|             line header               |  F=0 Line=4318 C=0 Offset=7168
|>>...data(line=2160/2160)         ...<<|
+=======================================+

底场：
+=============[ Packet #1 ]=============+
|                  ...                  |  Seq counter=0 Extened Seq counter=0
|                  ...                  |  Length=1280
|             line header               |  F=1 Line=1 C=0 Offset=0
|>>...data(line=1/2160)            ...<<|  
+---------------------------------------+
|                  ...                  |  Seq counter=1 Extened Seq counter=0
|                  ...                  |  Length=1280
|             line header               |  F=1 Line=1 C=0 Offset=512
|>>...data(line=1/2160)            ...<<|  
+---------------------------------------+
:                                       :
+---------------------------------------+
|                  ...                  |  Seq counter=15 Extened Seq counter=0
|                  ...                  |  Length=1280
|             line header               |  F=1 Line=3 C=0 Offset=0
|>>...  data(line=2/2160)          ...<<|  
+---------------------------------------+
:                                       :
+---------------------------------------+
|                  ...                  |  Seq counter=32399 Extened Seq counter=0
|                  ...                  |  Length=1280
|             line header               |  F=1 Line=4319 C=0 Offset=7168
|>>...data(line=2160/2160)         ...<<|
+=======================================+

```
